<!doctype html>
<html lang=en>

<head>
    <meta charset=utf-8>
    <title>Cube Player</title>
    <meta name=author content="Chris Mitchell">
    <link rel=stylesheet href=style.css>
    <script src="utils.js"></script>
    <script src="Point.js"></script>
    <script src="Vector.js"></script>
    <script src="Cube.js"></script>
    <script src="render.js"></script>
    <script>
        'use strict';

        /* Functions for applying custom/preset moves
         * ========================================== */
        var scrambled = false;

        function applyMoves(movesString) {
            var moves = parseMoves(movesString);
            //cube = moves.reduce(move, cube);
            for (var i = 0; i < moves.length; i++) {
                cube = move(cube, moves[i]);
            }
        }

        function resetCube() {
            cube = newCube();

            var captionEl = document.getElementById('caption');
            captionEl.innerHTML = 'A solved cube.';
        }

        function onResetCube(e) {
            resetCube();
            scrambled = false;
            redraw();

            e.preventDefault();
        }

        function onApply_(movesString) {
            applyMoves(movesString);
            var captionEl = document.getElementById('caption');
            // this logic is to determine if we're replacing the "A solved
            // cube." caption or appending new moves to the caption.
            movesString = '<samp>' + movesString + '</samp>';
            if (scrambled === false) {
                captionEl.innerHTML = movesString;
            } else {
                captionEl.innerHTML = captionEl.innerHTML + '<br>' + movesString;
            }
            scrambled = true;
            redraw();
        }

        function onApplyPreset(e) {
            var movesString = document.getElementById('preset-moves').value;
            onApply_(movesString);

            e.preventDefault();
        }

        function onApplyCustom(e) {
            var movesString = document.getElementById('custom-moves').value;
            if (isValidMovesString(movesString)) {
                onApply_(movesString);
            } else {
                // TODO: make this less annoying.
                alert('Please check your input -- that doesn\'t look like a proper moves string.');
            }

            e.preventDefault();
        }


        /* Input Validation
         * ================ */
        var isValidMovesString = function(movesString) {
            var validRegex = /^ *([UDFBLR][2']? *)+$/;
            return validRegex.test(movesString);
        }


        /* Drag to tumble functionality
         * ============================ */
        var x = -0.4; 
        var y =  0.5; 
        var z =  0;

        // data used to manage the click-to-tumble feature
        var tumbleInfo = {
            dragging: false,
            // the start of the drag
            clickX: null,
            clickY: null,
            // the pre-drag tumble orientation
            startX: null,
            startY: null
        };
        function onMouseMove(e) {
            if (tumbleInfo.dragging) {
                y = tumbleInfo.startY + 0.01 * (tumbleInfo.clickX - e.screenX);
                x = tumbleInfo.startX + 0.01 * (tumbleInfo.clickY - e.screenY);
                if (x > Math.PI/2) {
                    x = Math.PI/2;
                }
                else if (x < -Math.PI/2) {
                    x = -Math.PI/2;
                }
            }
        }

        function onMouseDown(e) {
            tumbleInfo.dragging = true;
            tumbleInfo.clickX = e.screenX;
            tumbleInfo.clickY = e.screenY;
            tumbleInfo.startX = x;
            tumbleInfo.startY = y;
            animate();
        }

        function onMouseUp(e) {
            tumbleInfo.dragging = false;
        }

        function redraw() {
            drawShape(cube.tumble(x, y, z));
        }

        function animate() {
            redraw();
            if (tumbleInfo.dragging) {
                setTimeout(animate, 20);
            }
        }

        /* Attach event handlers and init graphics
         * ======================================= */
        function setup() {
            var canvas = document.getElementById('canvas');
            canvas.addEventListener('mousedown', onMouseDown, false);
            window.addEventListener('mouseup', onMouseUp, false);
            window.addEventListener('mousemove', onMouseMove, false);

            var resetButtons = document.querySelectorAll('.reset-button');
            resetButtons[0].addEventListener('click', onResetCube, false);
            resetButtons[1].addEventListener('click', onResetCube, false);
            document.getElementById('preset-form').addEventListener('submit',
                onApplyPreset, false);
            document.getElementById('custom-form').addEventListener('submit',
                onApplyCustom, false);

            initializeCanvas(canvas);
            redraw();
        }

        window.onload = setup;
    </script>
</head>

<body>
    <h1>Cube Player</h1>
    <p>Experiment with applying different patterns to a cube. Click and drag the cube to see it from other angles. The cube's caption will describe what moves have been applied to it.</p>

    <figure>
        <canvas id=canvas width=400 height=400></canvas>
        <figcaption id=caption>A solved cube.</figcaption>
    </figure>

    <section id=controls>
        <h2>Apply your own moves</h2>
        <h3>Use a preset</h3>
        <form id=preset-form>
            <select id=preset-moves>
                <option value="F2 B2 R2 L2 U2 D2">Checkers</option>
                <option value="U D' R L' F B' U D'">Spots</option>
                <option value="F L F U' R U F2 L2 U' L' B D' B' L2 U">Cube in Cube</option>
                <option value="L B2 D R B' F D' L' R D' U F' R2 U'">Snake</option>
                <option value="F U2 L F L' B L U B' R' L' U R' D' F' B R2">Exchanged Peaks</option>
                <option value="F U F R L2 B D' R D2 L D' B R2 L F U F">Stripes</option>
            </select>
            <input type=submit id=apply-preset value=Apply>
            <input type=button class=reset-button value=Reset>
        </form>

        <h3>Use your own moves</h3>
        <form id=custom-form>
            <input id=custom-moves placeholder="example: UR2U'">
            <input type=submit id=apply-custom value=Apply>
            <input type=button class=reset-button value=Reset>
        </form>

        <p>Valid moves are given by <samp>F</samp>, <samp>B</samp>, <samp>U</samp>, <samp>D</samp>, <samp>L</samp>, <samp>R</samp>, which represent rotating the front, back, up, down, left, or right faces a quarter-turn clockwise. Counter-clockwise or 180 degree turns are done by adding either a <samp>'</samp> (single prime) or a <samp>2</samp> directly after a face. <samp>F2</samp> means "rotate the front face 180 degrees".</p>
    </section>
</body>

</html>
