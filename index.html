<!doctype html>
<html lang=en>

<head>
    <meta charset=utf-8>
    <title>Cube Player</title>
    <meta name=author content="Chris Mitchell">
    <style>
        canvas {
            border: 2px solid blue;
        }
    </style>
    <script>
        var canvas;
        var ctx;

        var points = [
            new Point( 1, 1, 1), // 0
            new Point( 1, 1,-1), // 1
            new Point( 1,-1, 1), // 2
            new Point( 1,-1,-1), // 3
            new Point(-1, 1, 1), // 4
            new Point(-1, 1,-1), // 5
            new Point(-1,-1, 1), // 6
            new Point(-1,-1,-1), // 7
        ];
        var faces = [
            [0, 2, 6, 4], // Front
            [5, 7, 3, 1], // Back
            [1, 0, 4, 5], // Up
            [2, 3, 7, 6], // Down
            [4, 6, 7, 5], // Left
            [1, 3, 2, 0], // Right
        ];
        var colors = [
            'red',
            'orange',
            'yellow',
            'green',
            'blue',
            'purple',
        ];



        function Point(x, y, z) {
            this.x = x;
            this.y = y;
            this.z = z;
        }

        /** Project a 3D point into the xy view-plane.
         * dist -- how far camera is from origin (on z axis)
         * halfAngle -- like a FOV
         */
        Point.prototype.project = function(dist, halfAngle) {
            var tan = Math.tan(halfAngle);
            var x = tan * this.x / (this.z - dist);
            var y = tan * this.y / (this.z - dist);
            return new Point(x, y, this.z);
        }

        /** Rotate point `rads` radians along the x axis. 
         * The following derivation uses `hyp` as distance of this from origin,
         * angle as angle of `this` from x-axis, and `delta` as desired rotation
         * angle):
         *
         * this.x = hyp * cos(angle)
         * this.y = hyp * sin(angle)
         * newX = hyp * cos(angle + delta) 
         *      = hyp * cos(angle) * cos(delta) - hyp * sin(angle) * sin(delta) 
         *      = this.x * cos(delta) - this.y * sin(delta)
         * newY = hyp * sin(angle + delta) 
         *      = hyp * sin(angle) * cos(delta) + hyp * cos(angle) * sin(delta) 
         *      = this.y * cos(delta) - this.x * sin(delta)
         */
        Point.prototype.rotateZ = function(rads) {
            var cosTheta = Math.cos(rads);
            var sinTheta = Math.sin(rads);
            var x = this.x * cosTheta - this.y * sinTheta;
            var y = this.y * cosTheta + this.x * sinTheta;
            return new Point(x, y, this.z);
        }

        Point.prototype.rotateX = function(rads) {
            var cosTheta = Math.cos(rads);
            var sinTheta = Math.sin(rads);
            var y = this.y * cosTheta - this.z * sinTheta;
            var z = this.z * cosTheta + this.y * sinTheta;
            return new Point(this.x, y, z);
        }

        Point.prototype.rotateY = function(rads) {
            var cosTheta = Math.cos(rads);
            var sinTheta = Math.sin(rads);
            var z = this.z * cosTheta - this.x * sinTheta;
            var x = this.x * cosTheta + this.z * sinTheta;
            return new Point(x, this.y, z);
        }



        function Vector(x, y, z) {
            this.x = x;
            this.y = y;
            this.z = z;
        }

        Vector.prototype.subtract = function(vec) {
            return new Vector(this.x - vec.x, this.y - vec.y, this.z - vec.z);
        }

        Vector.prototype.dot = function(vec) {
            return this.x * vec.x + this.y * vec.y + this.z * vec.z;
        }

        Vector.prototype.cross = function(vec) {
            var x = this.x * vec.z - this.z * vec.y;
            var y = this.z * vec.x - this.x * vec.z;
            var z = this.x * vec.y - this.y * vec.x;
            return new Vector(x, y, z);
        }



        /** Backface culling check to see if the face is visible 
         * face -- list of point indices for the given face. Must be given in
         *     clockwise order.
         */
        function isFaceVisible(face, points) {
            var pt0 = points[face[0]];
            var pt1 = points[face[1]];
            var pt2 = points[face[2]];
            var vecA = new Vector(pt1.x - pt0.x,
                                  pt1.y - pt0.y,
                                  pt1.z - pt0.z);
            var vecB = new Vector(pt2.x - pt0.x,
                                  pt2.y - pt0.y,
                                  pt2.z - pt0.z);
            var camVec = new Vector(0, 0, -4);

            var normal = vecA.cross(vecB);
            var dotProd = normal.dot(camVec);
            return (dotProd > 0);
        }

        function drawCube(rotX, rotY, rotZ) {
            ctx.clearRect(-0.5, -0.5, 1, 1);
            projected = [];
            for (var i = 0; i < points.length; i++) {
                var point = points[i].rotateX(rotX).rotateY(rotY).rotateZ(rotZ).project(4, Math.PI/4);
                projected.push(point);
            }
            for (faceIdx = 0; faceIdx < faces.length; faceIdx++) {
                if (isFaceVisible(faces[faceIdx], projected) == false) {
                    continue;
                }
                ctx.beginPath();
                for (i = 0; i < faces[faceIdx].length; i++) {
                    point = projected[faces[faceIdx][i]];
                    ctx.lineTo(point.x, point.y);
                }
                ctx.fillStyle = colors[faceIdx];
                ctx.fill();
            }
        }

        function setup() {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');

            ctx.translate(canvas.width/2, canvas.height/2); // put origin in center of canvas
            scale = Math.min(canvas.width, canvas.height);
            ctx.scale(scale, scale); // normalize the shortest canvas-dimension to 1 unit
            ctx.lineWidth = 1/scale; // make lineWidth one pixel again

            var angle = 0;
            setInterval(function() {
                drawCube(angle, angle, angle);
                angle += 0.025;
            }, 20);
        }

        window.onload = setup;
    </script>
</head>

<body>
    <h1>Cube Player</h1>
    <canvas id=canvas width=500 height=500></canvas>
</body>

</html>
